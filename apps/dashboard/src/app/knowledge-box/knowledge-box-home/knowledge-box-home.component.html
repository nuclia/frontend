<div class="knowledge-box-home page-spacing">
  @if (kbUrl | async; as kbUrl) {
    @if (showLeftColumn | async) {
      <div class="column-container">
        @if (canUpgrade | async) {
          <nsi-home-container class="small-container account-type-container">
            <app-account-status></app-account-status>
          </nsi-home-container>
        }

        @if (isKbContrib | async) {
          <nsi-home-container class="small-container">
            <div class="upload-data">
              <div class="title-m">{{ 'dashboard-home.upload-block.title' | translate }}</div>
              <pa-button
                [routerLink]="kbUrl + '/upload'"
                class="full-width"
                aspect="solid"
                kind="primary"
                iconAndText
                icon="upload">
                <a [routerLink]="kbUrl + '/upload'">
                  {{ 'stash.upload_data' | translate }}
                </a>
              </pa-button>
              <div>
                {{ 'dashboard-home.upload-block.description' | translate }}
                @if (isDownloadDesktopEnabled | async) {
                  {{ 'dashboard-home.upload-block.description-desktop' | translate }}
                }
              </div>
              <stf-desktop-sources *ngIf="isDownloadDesktopEnabled | async"></stf-desktop-sources>
            </div>
          </nsi-home-container>
        }

        <nsi-home-container class="small-container">
          <app-kb-metrics
            [locale]="locale | async"
            [metrics]="counters | async"></app-kb-metrics>
        </nsi-home-container>

        <nsi-home-container class="small-container">
          <div class="desktop-container">
            <img
              src="assets/logos/nuclia-desktop.svg"
              alt="Nuclia Desktop" />
            <div>
              {{ 'dashboard-home.desktop.description' | translate }}
            </div>
            <pa-button
              class="full-width"
              (click)="openDesktop()">
              {{ 'dashboard-home.desktop.open' | translate }}
            </pa-button>

            <small>{{ 'dashboard-home.desktop.available-for' | translate }}</small>
          </div>
        </nsi-home-container>
      </div>
    }

    <div class="column-container wide-column">
      <nsi-home-container>
        <div class="kb-details">
          <div class="title-m title-with-action">
            {{ 'dashboard-home.kb-details.title' | translate }}
            @if (isKbAdmin) {
              <pa-button
                [routerLink]="kbUrl + '/manage'"
                icon="gear"
                aspect="basic">
                {{ 'dashboard-home.go-to.kb-settings' | translate }}
              </pa-button>
            }
          </div>

          <div>
            <div class="title-xxs">{{ 'dashboard-home.kb-details.endpoint' | translate }}</div>
            <div class="details-block">
              @if (clipboardSupported) {
                <pa-button
                  aspect="basic"
                  size="small"
                  [icon]="copyIcon.endpoint"
                  (click)="copyEndpoint()">
                  {{ 'generic.copy' | translate }}
                </pa-button>
              }
              <pre><code>{{ endpoint | async }}</code></pre>
            </div>
          </div>
          <div>
            <div class="title-xxs">{{ 'dashboard-home.kb-details.uid' | translate }}</div>
            <div class="details-block">
              @if (clipboardSupported) {
                <pa-button
                  aspect="basic"
                  size="small"
                  [icon]="copyIcon.uid"
                  (click)="copyUid()">
                  {{ 'generic.copy' | translate }}
                </pa-button>
              }
              <pre><code>{{ uid | async }}</code></pre>
            </div>
          </div>
          <div>
            <div class="title-xxs">{{ 'dashboard-home.kb-details.slug' | translate }}</div>
            <div class="details-block">
              @if (clipboardSupported) {
                <pa-button
                  aspect="basic"
                  size="small"
                  [icon]="copyIcon.slug"
                  (click)="copySlug()">
                  {{ 'generic.copy' | translate }}
                </pa-button>
              }
              <pre><code>{{ slug | async }}</code></pre>
            </div>
          </div>
          @if ((configuration | async)?.generative_model; as model) {
            <div>
              <div class="title-xxs">{{ 'dashboard-home.kb-details.language-model' | translate }}</div>
              <div class="body-s">
                {{ 'stash.config.option.' + model | translate }}
              </div>
            </div>
          }
          <div class="title-xxs">
            {{ stateLabel | async | translate }}
          </div>
        </div>
      </nsi-home-container>

      <div class="row-container">
        @if ((showLeftColumn | async) === false) {
          <nsi-home-container class="small-container fit-content">
            <app-kb-metrics
              [locale]="locale | async"
              [metrics]="counters | async"></app-kb-metrics>
          </nsi-home-container>
        }

        <nsi-home-container
          class="growing-container"
          [class.fit-content]="(lastUploadedResources | async)?.length < 6">
          <div class="kb-content">
            <section>
              <div class="title-m title-with-action">
                {{ 'dashboard-home.kb-content.latest-resources.title' | translate }}
                <pa-button
                  icon="list"
                  aspect="basic"
                  [routerLink]="kbUrl + '/resources'">
                  {{ 'dashboard-home.go-to.resource-list' | translate }}
                </pa-button>
              </div>
              @if ((lastUploadedResources | async)?.length === 0) {
                <p class="no-content">
                  {{ 'dashboard-home.kb-content.latest-resources.no-upload' | translate }}
                </p>
              } @else {
                <ul class="latest-uploaded-list">
                  @for (resource of lastUploadedResources | async; track resource.id) {
                    <li
                      paEllipsisTooltip
                      [routerLink]="kbUrl + '/resources/' + resource.id + '/edit/preview'">
                      @if (resource.icon | mimeIcon; as icon) {
                        <pa-icon [name]="icon"></pa-icon>
                      }
                      {{ resource.title }}
                    </li>
                  }
                </ul>
              }
            </section>

            <section>
              <div class="title-m title-with-action">
                {{ 'dashboard-home.kb-content.processing-queue.title' | translate }}
                <pa-button
                  icon="clock-dash"
                  aspect="basic"
                  [routerLink]="kbUrl + '/resources/pending'">
                  {{ 'dashboard-home.go-to.pending-list' | translate }}
                </pa-button>
              </div>

              @if ((pendingResourceCount | async) === 0) {
                <p class="no-content">
                  {{ 'dashboard-home.kb-content.processing-queue.no-pending' | translate }}
                </p>
              } @else {
                <p class="body-m">
                  {{
                    'dashboard-home.kb-content.processing-queue.pending'
                      | translate: { count: pendingResourceCount | async }
                  }}
                </p>
              }
            </section>
          </div>
        </nsi-home-container>

        @if (isAccountManager | async) {
          <nsi-home-container class="growing-container">
            <div class="usage-charts">
              <div class="title-m title-with-action">
                {{ 'dashboard-home.usage.title' | translate }}

                <div>
                  <nsi-dropdown-button
                    freeWidth
                    aspect="basic"
                    [popupRef]="chartDropdown"
                    [open]="isChartDropdownOpen">
                    {{ currentChart.label | translate }}
                  </nsi-dropdown-button>

                  <pa-dropdown
                    #chartDropdown
                    (onClose)="isChartDropdownOpen = false"
                    (onOpen)="isChartDropdownOpen = true">
                    @for (option of chartDropdownOptions; track option.id) {
                      <pa-option
                        [value]="option.value"
                        (selectOption)="selectChart(option)">
                        {{ option.label | translate }}
                      </pa-option>
                    }
                  </pa-dropdown>
                </div>
                <pa-button
                  aspect="basic"
                  icon="fullscreen"
                  (click)="openFullscreen()">
                  {{ 'dashboard-home.usage.fullscreen' | translate }}
                </pa-button>
              </div>

              <div class="chart-container">
                <app-kb-usage-charts
                  smallContainer
                  [chartHeight]="chartHeight"
                  [currentChart]="currentChart"
                  [processingChart]="processingChart | async"
                  [searchChart]="searchChart | async"></app-kb-usage-charts>

                <pa-table columns="2fr 1fr 1fr">
                  <pa-table-header>
                    <pa-table-cell></pa-table-cell>
                    <pa-table-cell>
                      <span class="body-s">{{ 'metrics.period.last-30-days' | translate }}</span>
                    </pa-table-cell>
                    <pa-table-cell>
                      <span class="body-s">{{ 'metrics.period.last-12-months' | translate }}</span>
                    </pa-table-cell>
                  </pa-table-header>
                  @if (searchQueriesCounts | async; as queriesCount) {
                    <pa-table-row>
                      <pa-table-cell>
                        <span class="body-s">{{ 'metrics.search.title' | translate }}</span>
                      </pa-table-cell>
                      <pa-table-cell>
                        <span class="body-s">
                          <strong>{{ queriesCount.month | number: '1.0-0' : (locale | async) }}</strong>
                        </span>
                      </pa-table-cell>
                      <pa-table-cell>
                        <span class="body-s">
                          <strong>{{ queriesCount.year | number: '1.0-0' : (locale | async) }}</strong>
                        </span>
                      </pa-table-cell>
                    </pa-table-row>
                  }
                </pa-table>
              </div>
            </div>
          </nsi-home-container>
        }
      </div>
    </div>
  }
</div>

@if ((searchQueriesCounts | async)?.year; as yearCount) {
  <app-knowledge-box-survey [totalSearch]="yearCount"></app-knowledge-box-survey>
}
