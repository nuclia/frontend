<div class="label-selector">
  <nsi-dropdown-button
    [disabled]="disabled"
    [fullWidth]="fullWidth"
    [popupRef]="labelSelection"
    [size]="size"
    [aspect]="aspect"
    [open]="open"
    [freeWidth]="fullWidth">
    <ng-content></ng-content>
  </nsi-dropdown-button>

  <pa-dropdown
    #labelSelection
    [dontAdjustPosition]="!fullWidth"
    [companionElement]="level2Element?.nativeElement"
    (onClose)="closeDropdowns()"
    (onOpen)="open = true">
    @for (labelSet of labelSets | keyvalue; track labelSet) {
      @if (labelSet.value.labels.length > 0) {
        <pa-option
          icon="chevron-right"
          iconOnRight
          popupOnRight
          dontCloseOnSelect
          [paPopup]="level2"
          [popupVerticalOffset]="-40"
          [selected]="selectedLabelSet === labelSet.key || labelSetExpanded === labelSet.key"
          (selectOption)="onLevel1Selection(labelSet.key, labelSet.value)">
          <span
            class="label-color"
            [style.background-color]="labelSet.value.color"></span>
          {{ labelSet.value.title }}
        </pa-option>
      }
    }
  </pa-dropdown>

  <pa-dropdown
    #level2
    dontAdjustPosition
    keepOthersOpen>
    @if (labelValues.length > maxLabels) {
      <pa-option
        class="filter"
        dontCloseOnSelect>
        <pa-input
          icon="search"
          [(value)]="filter"
          (keyUp)="filterLabels(labelSetExpanded)">
          {{ 'stash.search' | translate }}
        </pa-input>
      </pa-option>
    }
    @if (
      selectAll && (labelSets?.[labelSetExpanded]?.multiple || forceMultiple) && labelValues.length > 1 && !forceSingle
    ) {
      <pa-option
        class="level2-option"
        dontCloseOnSelect>
        <pa-checkbox
          [value]="selectedLabelSets[labelSetExpanded]"
          (change)="toggleLabelSet(labelSetExpanded)">
          {{ 'generic.select_all' | translate }}
        </pa-checkbox>
      </pa-option>
      <pa-separator></pa-separator>
    }
    @for (labelValue of filteredLabels || labelValues | slice: 0 : maxLabels; track labelValue) {
      <pa-option
        class="level2-option"
        [dontCloseOnSelect]="!forceSingle"
        (selectOption)="onOptionSelection(labelValue, $event)">
        @if (forceSingle) {
          {{ labelValue.label }}
        } @else {
          <pa-checkbox
            [value]="checkboxSelection.includes(labelValue.labelset + labelValue.label)"
            (change)="toggleLabel(labelValue)">
            {{ labelValue.label }}
          </pa-checkbox>
        }
      </pa-option>
    }
  </pa-dropdown>
</div>
