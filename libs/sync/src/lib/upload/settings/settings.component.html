<h2 class="unit-test">{{ 'upload.source.settings' | translate }}</h2>
<p>{{ 'upload.source.settings-description' | translate }}</p>
<form
  *ngIf="!!fields && !!form"
  [formGroup]="form"
  qa="fields-form"
  (ngSubmit)="validate()">
  <div class="selected-source">
    <img
      [src]="connector?.logo"
      [alt]="connector?.title" />
    <div>{{ connector?.title || '' }}</div>
  </div>
  <div class="settings">
    <div class="field">
      <pa-input
        formControlName="name"
        [errorMessages]="validationMessages['name']">
        {{ 'upload.source.name' | translate }}
      </pa-input>
    </div>
  </div>
  <div
    *ngFor="let field of fields"
    formGroupName="fields"
    class="field">
    <pa-input
      *ngIf="field.type === 'text'"
      [help]="field.help ? (field.help | translate) : undefined"
      [placeholder]="field.placeholder"
      [formControlName]="field.id">
      {{ field.label | translate }}
    </pa-input>
    <pa-textarea
      *ngIf="field.type === 'textarea'"
      [help]="field.help ? (field.help | translate) : undefined"
      [formControlName]="field.id">
      {{ field.label | translate }}
    </pa-textarea>
    <div
      *ngIf="field.type === 'select'"
      class="select-field-container">
      <pa-select
        [formControlName]="field.id"
        [label]="field.label">
        <pa-option
          *ngFor="let option of field.options"
          [disabled]="option.disabled"
          [value]="option.value">
          {{ option.label }}
        </pa-option>
      </pa-select>
    </div>
  </div>
  <div
    *ngIf="connector?.helpUrl"
    class="help">
    <pa-icon
      size="small"
      name="info"></pa-icon>
    <a
      [href]="connector?.helpUrl"
      (click)="goToUrl($event, connector?.helpUrl || '')"
      target="_blank"
      rel="noopener noreferrer">
      {{ 'upload.source.help' | translate: { source: connector?.title || '' } }}
    </a>
  </div>

  <div
    class="settings"
    *ngIf="!connector?.permanentSyncOnly">
    <div class="field">
      <pa-checkbox formControlName="permanentSync">
        {{ 'upload.source.permanent-sync' | translate }}
      </pa-checkbox>
    </div>
  </div>

  <div class="destination">
    <div class="body-m">{{ 'upload.source.destination' | translate }}:</div>
    <div>
      <pa-checkbox
        formControlName="local"
        (valueChange)="onToggleLocal($event)">
        {{ 'upload.source.use-nucliadb' | translate }}
      </pa-checkbox>
    </div>
    <ng-container *ngIf="!local">
      <div
        *ngIf="kbField"
        class="select-field-container">
        <pa-select
          formControlName="kb"
          [label]="kbField.label">
          <pa-option
            *ngFor="let option of kbField.options"
            [disabled]="option.disabled"
            [value]="option.value">
            {{ option.label }}
          </pa-option>
        </pa-select>
        <pa-button
          *ngIf="kbField.canBeRefreshed"
          icon="refresh"
          aspect="basic"
          [paTooltip]="'upload.refresh' | translate: { field: kbField.label }"
          (click)="refreshKbs(local)">
          {{ 'upload.refresh' | translate: { field: kbField.label } }}
        </pa-button>
      </div>
    </ng-container>
    <ng-container *ngIf="local">
      <div>
        <pa-input
          formControlName="localUrl"
          placeholder="http://localhost:8080/api">
          {{ 'upload.source.nucliadb-url' | translate }}
        </pa-input>
      </div>
      <div
        *ngIf="localKbField"
        class="select-field-container">
        <pa-select
          formControlName="localKb"
          [label]="localKbField.label">
          <pa-option
            *ngFor="let option of localKbField.options"
            [disabled]="option.disabled"
            [value]="option.value">
            {{ option.label }}
          </pa-option>
        </pa-select>
      </div>
    </ng-container>
    <ng-container *ngIf="(labelSets | async) !== null">
      <div
        *ngIf="(hasLabelSets | async) === true"
        class="field">
        <label
          class="body-m"
          for="label-expander">
          {{ 'upload.labels' | translate }}
        </label>
        <div class="labels-container">
          <nsi-labels-expander
            id="label-expander"
            [labelSets]="labelSets | async"
            [currentSelection]="currentSelection"
            (updateSelection)="updateLabelSelection($event)"></nsi-labels-expander>
          <div>
            <app-label-list
              [labelSets]="labelSets | async"
              [labelSelection]="selectedLabels"
              (labelSelectionChange)="updateLabels($event)"></app-label-list>
          </div>
        </div>
      </div>
      <div
        *ngIf="(hasLabelSets | async) === false"
        class="field">
        <div class="body-m">
          <a
            [href]="dashboardUrl"
            (click)="goToUrl($event, dashboardUrl)"
            target="_blank"
            rel="noopener noreferrer">
            {{ 'upload.no-labels' | translate }}
          </a>
        </div>
      </div>
    </ng-container>
  </div>

  <div class="buttons">
    <pa-button
      qa="save"
      type="submit"
      kind="primary"
      [disabled]="form.invalid">
      {{ 'generic.save' | translate }}
    </pa-button>
    <pa-button
      qa="cancel"
      aspect="basic"
      (click)="onCancel()">
      {{ 'generic.cancel' | translate }}
    </pa-button>
  </div>
</form>
