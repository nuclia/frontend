<div
  class="subform-field"
  [formGroup]="form">
  <div class="subform-header">
    <label class="subform-label">
      {{ label }}
      @if (required) {
        <span
          style="color: red">
          *
        </span>
      }
    </label>
    @if (property.description) {
      <small
        class="subform-description">
        {{ property.description }}
      </small>
    }
  </div>

  @if (subFormGroup && renderableFields.length > 0) {
    <div
      class="subform-content"
      >
      <div [formGroup]="subFormGroup">
        <!-- Render fields directly using the same logic as FieldRendererComponent but without circular dependency -->
        @for (field of renderableFields; track field) {
          <div
            class="subform-field-item">
            @switch (field.config.component) {
              <!-- Array string field -->
              @case ('array-string-field') {
                <app-array-string-field
                  [form]="subFormGroup"
                  [arrayName]="field.key"
                  [label]="field.label"
                [required]="field.required"></app-array-string-field>
              }
              <!-- Code editor -->
              @case ('code-editor') {
                <app-code-editor
                  [form]="subFormGroup"
                  [controlName]="field.key"
                  [label]="field.label"
                  [property]="field.property"
                  [required]="field.required"
                  [initialLanguage]="field.config.additionalProps?.['initialLanguage'] || 'javascript'"
                  [availableLanguages]="field.config.additionalProps?.['availableLanguages']"
                [showLanguageSelector]="field.config.additionalProps?.['showLanguageSelector'] ?? true"></app-code-editor>
              }
              <!-- Driver select -->
              @case ('driver-select') {
                <app-driver-select
                  [label]="field.label"
                  [required]="field.required"
                  [form]="subFormGroup"
                  [controlName]="field.key"
                  [provider]="field.config.additionalProps?.['provider']"
                [multiselect]="field.config.additionalProps?.['multiselect']"></app-driver-select>
              }
              <!-- Enum select -->
              @case ('enum-select') {
                <app-enum-select
                  [form]="subFormGroup"
                  [controlName]="field.key"
                  [label]="field.label"
                  [property]="field.property"
                [required]="field.required"></app-enum-select>
              }
              <!-- Filtered Source Select -->
              @case ('filtered-source-select') {
                <app-filtered-source-select
                  [form]="subFormGroup"
                  [controlName]="field.key"
                  [label]="field.label"
                  [property]="field.property"
                [required]="field.required"></app-filtered-source-select>
              }
              <!-- Model select fields -->
              @case ('model-select') {
                <app-model-select
                  [label]="field.label"
                  [required]="field.required"
                  [form]="subFormGroup"
                [controlName]="field.key"></app-model-select>
              }
              <!-- Rules field -->
              @case ('rules-field') {
                <app-rules-field
                [form]="subFormGroup"></app-rules-field>
              }
              <!-- Transport field -->
              @case ('transport-field') {
                <app-transport-field
                  [form]="subFormGroup"
                  [controlName]="field.key"
                  [label]="field.label"
                  [property]="field.property"
                [required]="field.required"></app-transport-field>
              }
              <!-- Boolean toggle -->
              @case ('pa-toggle') {
                <pa-toggle
                  [formControlName]="field.key"
                  [required]="field.required"
                  withBackground>
                  {{ field.label }}
                  @if (field.required) {
                    <span
                      style="color: red">
                      *
                    </span>
                  }
                </pa-toggle>
              }
              <!-- Custom placeholder for TODO fields -->
              @case ('custom-placeholder') {
                <div>
                  <label>
                    <i>[Custom]</i>
                    {{ field.label }}
                    @if (field.required) {
                      <span
                        style="color: red">
                        *
                      </span>
                    }
                  </label>
                </div>
              }
              <!-- Text input and fallback -->
              @default {
                <pa-input
                  [id]="field.key"
                  [formControlName]="field.key"
                  [type]="getFieldType(field)"
                  [placeholder]="field.property.description || ''"
                  [help]="field.property.description || ''"
                  [required]="field.required">
                  {{ field.label }}
                  @if (field.required) {
                    <span
                      style="color: red">
                      *
                    </span>
                  }
                </pa-input>
              }
            }
          </div>
        }
      </div>
    </div>
  }

  @if (renderableFields.length === 0) {
    <div
      class="subform-placeholder">
      <em>Unable to resolve schema.</em>
    </div>
  }
</div>
