@if (kb) {
  <div class="knowledge-box-settings page-spacing">
    <div class="section">
      <h1>{{ 'stash.profile' | translate }}</h1>

      @if (kbForm) {
        <form
          [formGroup]="kbForm"
          (ngSubmit)="saveKb()">
          <pa-input
            formControlName="uid"
            readonly>
            {{ 'generic.uid' | translate }}
          </pa-input>

          <pa-input
            formControlName="zone"
            readonly>
            {{ 'generic.zone' | translate }}
          </pa-input>

          <pa-input
            formControlName="slug"
            [errorMessages]="validationMessages['slug']">
            {{ 'generic.slug' | translate }}
          </pa-input>

          <pa-input
            formControlName="title"
            [errorMessages]="validationMessages['title']">
            {{ 'generic.name' | translate }}
          </pa-input>

          <pa-textarea
            formControlName="description"
            [rows]="4">
            {{ 'generic.description' | translate }}
          </pa-textarea>

          @if (kb?.state?.toLowerCase(); as state) {
            <div class="kb-status">
              <h3 class="title-m">{{ 'stash.settings.status.label' | translate }}</h3>
              <div class="body-m">
                <span [innerHTML]="'stash.settings.status.' + state | translate"></span>
              </div>
              <pa-button (click)="toggleKbState()">
                {{ (state === 'published' ? 'account.stash.retire' : 'account.stash.publish') | translate }}
              </pa-button>
            </div>
          }

          @for (conf of displayedLearningConfigurations; track conf.id) {
            <div
              formGroupName="config"
              class="config">
              <div class="header">
                <h3 class="title-m">{{ 'stash.create.' + conf.id + '.label' | translate }}</h3>
                <div class="body-m">{{ 'stash.create.' + conf.id + '.help' | translate }}</div>
              </div>
              <div>
                <pa-radio-group
                  [formControlName]="conf.id"
                  [name]="conf.id"
                  (valueChange)="conf.id === 'generative_model' ? updateUserPrompts($event) : undefined"
                  [class.two-columns]="(conf.data.options || []).length > 5">
                  @for (option of conf.data.options; track option.value) {
                    <pa-radio [value]="option.value">
                      {{ option | learningOption: conf.id }}
                    </pa-radio>
                  }
                </pa-radio-group>
                @if (getVisibleFieldGroup(conf); as groupId) {
                  <div formGroupName="user_keys">
                    <div
                      class="user-keys"
                      [formGroupName]="groupId">
                      <pa-toggle
                        labelOnRight
                        [value]="ownKey"
                        (valueChange)="toggleOwnKey()">
                        {{ 'stash.config.own_key' | translate }}
                      </pa-toggle>
                      @if (ownKey) {
                        @if (hasTranslation('stash.config.key.' + groupId)) {
                          <div class="title-m">{{ 'stash.config.key.' + groupId | translate }}:</div>
                        }
                        <div>
                          @for (field of userKeys?.[groupId] || {} | keyvalue; track field) {
                            @if (field.value.textarea) {
                              <pa-textarea
                                [formControlName]="field.key"
                                [rows]="5">
                                {{ field.value.title | translate }}
                              </pa-textarea>
                            } @else {
                              <pa-input [formControlName]="field.key">
                                {{ field.value.title | translate }}
                              </pa-input>
                            }
                          }
                        </div>
                      }
                    </div>
                  </div>
                }

                @if (
                  (isUserPromptsEnabled | async) === true &&
                  conf.id === 'generative_model' &&
                  !!currentUserPromptConfig &&
                  currentUserPromptKey
                ) {
                  <div>
                    <div formGroupName="user_prompts">
                      @for (key of userPromptKeys; track key) {
                        <div [formGroupName]="key">
                          @if (key == currentUserPromptKey) {
                            <div>
                              @if (userPromptConfigurations?.schemas?.[key]?.properties; as properties) {
                                @if (properties['prompt']; as prompt) {
                                  <div class="user-prompts">
                                    <div class="header">
                                      <h3 class="title-m">{{ 'stash.create.user_prompts.prompt' | translate }}</h3>
                                      <div class="body-m">
                                        {{ 'stash.create.user_prompts.prompt_help' | translate }}
                                      </div>
                                    </div>
                                    <pa-select
                                      formControlName="prompt_examples"
                                      [dim]="true"
                                      [label]="'stash.create.user_prompts.examples' | translate"
                                      (valueChange)="setUserPrompt('prompt', key, $event)">
                                      @for (option of prompt.examples || []; track option) {
                                        <pa-option [value]="option">
                                          {{ option }}
                                        </pa-option>
                                      }
                                    </pa-select>
                                    <pa-textarea
                                      formControlName="prompt"
                                      [rows]="5"
                                      [help]="prompt.info || ''">
                                      {{ prompt.title }}
                                    </pa-textarea>
                                  </div>
                                }
                                @if (properties['system']; as system) {
                                  <div class="user-prompts">
                                    <div class="header">
                                      <h3 class="title-m">{{ 'stash.create.user_prompts.system' | translate }}</h3>
                                      <div class="body-m">
                                        {{ 'stash.create.user_prompts.system_help' | translate }}
                                      </div>
                                    </div>
                                    <pa-select
                                      formControlName="system_examples"
                                      [dim]="true"
                                      [label]="'stash.create.user_prompts.examples' | translate"
                                      (valueChange)="setUserPrompt('system', key, $event)">
                                      @for (option of system.examples || []; track option) {
                                        <pa-option [value]="option">
                                          {{ option }}
                                        </pa-option>
                                      }
                                    </pa-select>
                                    <pa-textarea
                                      formControlName="system"
                                      [rows]="5"
                                      [help]="system.info || ''">
                                      {{ system.title }}
                                    </pa-textarea>
                                  </div>
                                }
                              }
                            </div>
                          }
                        </div>
                      }
                    </div>
                  </div>
                }

                @if (
                  (isSummarizationEnabled | async) === true &&
                  conf.id === 'summary_model' &&
                  summaryPromptConfigurations
                ) {
                  <div formGroupName="summary_prompt">
                    @if (summaryPromptConfigurations?.schema?.properties; as properties) {
                      @if (properties['prompt']; as prompt) {
                        <div class="user-prompts">
                          <div class="header">
                            <h3 class="title-m">{{ 'stash.create.summary_prompt.prompt' | translate }}</h3>
                            <div class="body-m">
                              {{ 'stash.create.summary_prompt.prompt_help' | translate }}
                            </div>
                          </div>
                          <pa-select
                            formControlName="prompt_examples"
                            [dim]="true"
                            [label]="'stash.create.summary_prompt.examples' | translate"
                            (valueChange)="setSummaryPrompt($event)">
                            @for (option of prompt.examples || []; track option) {
                              <pa-option [value]="option">
                                {{ option }}
                              </pa-option>
                            }
                          </pa-select>
                          <pa-textarea
                            formControlName="prompt"
                            [rows]="5"
                            [help]="prompt.info || ''">
                            {{ prompt.title }}
                          </pa-textarea>
                        </div>
                      }
                    }
                  </div>
                }
              </div>
            </div>
          }

          <footer>
            <pa-button
              type="submit"
              kind="primary"
              data-cy="save-kb-settings"
              [disabled]="kbForm.invalid || kbForm.pristine || saving">
              {{ 'generic.save' | translate }}
            </pa-button>
            <pa-button
              aspect="basic"
              [disabled]="kbForm.pristine"
              (click)="initKbForm()">
              {{ 'generic.cancel' | translate }}
            </pa-button>
          </footer>
        </form>
      }
    </div>
  </div>
}
