<div class="remi-metrics page-spacing">
  <div>
    <h1 class="page-title">{{ 'kb.metrics.page-title' | translate }}</h1>
    <div
      class="page-description"
      [innerHTML]="'kb.metrics.page-description' | translate"></div>
  </div>

  <section class="period-container">
    <label for="period">{{ 'kb.metrics.period.label' | translate }}</label>
    <pa-select
      id="period"
      dim
      [(value)]="period">
      <pa-option value="24h">{{ 'kb.metrics.period.last-24h' | translate | lowercase }}</pa-option>
      <pa-option value="7d">{{ 'kb.metrics.period.last-7d' | translate | lowercase }}</pa-option>
      <pa-option value="14d">{{ 'kb.metrics.period.last-14d' | translate | lowercase }}</pa-option>
      <pa-option value="30d">{{ 'kb.metrics.period.last-30d' | translate | lowercase }}</pa-option>
    </pa-select>
  </section>
  <section>
    <div>
      <div class="title-l">{{ 'dashboard-home.health-status.title' | translate }}</div>
      <div class="page-description">
        {{ 'kb.metrics.health-status.description' | translate }}
      </div>
    </div>

    <div class="chart-container">
      <stf-range-chart [data]="(healthCheckData | async) || []"></stf-range-chart>
    </div>
  </section>
  <section>
    <div>
      <div class="title-l">{{ 'kb.metrics.performance-evolution.title' | translate }}</div>
      <div class="page-description">{{ 'kb.metrics.performance-evolution.description' | translate }}</div>
    </div>
    <div>
      <div class="chart-container">
        <stf-range-evolution-chart [data]="answerEvolution | async"></stf-range-evolution-chart>
        <div class="title-s">{{ 'metrics.remi.category-full.answer-relevance' | translate }}</div>
      </div>
      <div class="chart-container">
        <stf-range-evolution-chart [data]="contextEvolution | async"></stf-range-evolution-chart>
        <div class="title-s">{{ 'metrics.remi.category-full.context-relevance' | translate }}</div>
      </div>
      <div class="chart-container">
        <stf-range-evolution-chart [data]="groundednessEvolution | async"></stf-range-evolution-chart>
        <div class="title-s">{{ 'metrics.remi.category-full.groundedness' | translate }}</div>
      </div>
    </div>
  </section>
  <section>
    <div>
      <div class="title-l">{{ 'kb.metrics.missing-knowledge.title' | translate }}</div>
      <div class="page-description">{{ 'kb.metrics.missing-knowledge.description' | translate }}</div>
    </div>
    <div>
      <pa-accordion>
        @for (item of missingKnowledgeData | async; track item.id) {
          <pa-accordion-item
            [id]="item.id"
            [itemTitle]="item.question"
            [description]="
              item.answer +
              '<br><strong>' +
              ('metrics.remi.category-short.answer-relevance' | translate) +
              ': ' +
              item.remi.answer_relevance.score +
              '</strong> – ' +
              item.remi.answer_relevance.reason +
              '<br><strong>' +
              ('metrics.remi.category-short.context-relevance' | translate) +
              ':</strong> ' +
              (item.remi.context_relevance | json)
            "
            (expandedChange)="loadMissingKnowledgeDetails(item.id)">
            <pa-accordion-item-body>
              @if (missingKnowledgeDetails[item.id]; as details) {
                <ul class="context-list">
                  @for (context of details.context; track context.text_block_id) {
                    <li>
                      <strong>{{ item.remi.context_relevance[$index] }}</strong>
                      – {{ context.text }}
                    </li>
                  }
                </ul>
              } @else {
                <nsi-spinner></nsi-spinner>
              }
            </pa-accordion-item-body>
          </pa-accordion-item>
        }
      </pa-accordion>
    </div>
  </section>
</div>
